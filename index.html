<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Super Chat v16</title>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <style>
        :root { --main-blue: #0084ff; --bg-gray: #f0f2f5; --me-bubble: #0084ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        /* í°íŠ¸ ë° ëª¨ë°”ì¼ ì „ì²´ í™”ë©´ ê³ ì • */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background: #d1d8e0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }

        .app-container { width: 100%; max-width: 500px; background: var(--bg-gray); display: flex; flex-direction: column; height: 100%; position: relative; }
        
        /* í—¤ë”: ê°€ë…ì„± ë†’ì„ */
        header { background: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* ì±„íŒ…ì°½: ìŠ¤í¬ë¡¤ ìµœì í™” */
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }

        /* ë©”ì‹œì§€ ë””ìì¸: ëª¨ë°”ì¼ ê°„ê²© ì¡°ì • */
        .msg-unit { display: flex; flex-direction: column; max-width: 85%; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }
        .user-info { font-size: 12px; color: #777; margin-bottom: 4px; font-weight: 500; }
        .bubble { padding: 10px 15px; border-radius: 20px; font-size: 15px; word-break: break-all; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
        .is-me .bubble { background: var(--me-bubble); color: white; border-bottom-right-radius: 4px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 4px; }
        
        .draw-msg { max-width: 220px; border-radius: 12px; border: 1px solid #ddd; background: white; margin-top: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* í•˜ë‹¨ ì…ë ¥ì°½: ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘ ê°•í™” */
        .input-bar { background: white; padding: 10px 12px; border-top: 1px solid #e0e0e0; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .input-inner { display: flex; gap: 10px; align-items: center; background: #f1f3f5; padding: 4px 12px; border-radius: 24px; }
        #msg-input { flex: 1; border: none; background: transparent; padding: 10px 0; outline: none; font-size: 16px; color: #333; }
        .icon-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 4px; opacity: 0.8; }
        .send-btn { background: var(--main-blue); color: white; border: none; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .send-btn:active { transform: scale(0.9); }

        /* ë¡œê·¸ì¸ í™”ë©´ UI ê°œì„  */
        .auth-screen { position: fixed; inset: 0; background: #f8f9fa; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 35px 25px; border-radius: 24px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 16px; background: #fcfcfc; }
        
        /* ëª¨ë‹¬: ëª¨ë°”ì¼ íŒì—… ëŠë‚Œìœ¼ë¡œ ìˆ˜ì • */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        canvas { background: white; border: 1px solid #eee; width: 100%; aspect-ratio: 1/1; touch-action: none; border-radius: 12px; }
        .modal-btn { padding: 14px; border-radius: 12px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div style="font-weight:700; font-size:16px;">ğŸ’¬ <span id="user-count" style="color:var(--main-blue)">0</span></div>
            <div style="display:flex; gap:12px; align-items:center;">
                <div onclick="openProfile()" style="cursor:pointer; background:#f1f3f5; padding:6px 14px; border-radius:20px; font-size:14px; font-weight:500;">
                    <span id="h-emoji">ğŸ‘¤</span> <span id="h-name">ì„¤ì •</span>
                </div>
                <button onclick="logout()" style="border:none; background:none; color:#ff4d4d; font-size:13px; font-weight:500;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div id="chat-window"></div>

        <div class="input-bar" id="ui-input" style="display:none;">
            <div class="input-inner">
                <button onclick="openDraw()" class="icon-btn">ğŸ¨</button>
                <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                <button onclick="sendMsg()" class="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="auth-area" class="auth-screen">
        <div class="auth-card">
            <h2 style="margin-bottom:25px; color:#333; font-weight:800; letter-spacing:-0.5px;">Super Chat</h2>
            <input type="email" id="email" class="auth-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="emailAuth()" style="width:100%; padding:15px; background:var(--main-blue); color:white; border:none; border-radius:14px; font-weight:700; font-size:16px; margin-bottom:12px; box-shadow: 0 4px 12px rgba(0,132,255,0.2);">ë¡œê·¸ì¸ / ì‹œì‘í•˜ê¸°</button>
            <div style="margin-bottom:15px; font-size:13px; color:#aaa;">ë˜ëŠ”</div>
            <button onclick="googleLogin()" style="width:100%; padding:13px; background:white; border:1px solid #e0e0e0; border-radius:14px; display:flex; align-items:center; justify-content:center; gap:8px; font-weight:600; color:#555;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18"> Google ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <div id="draw-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-weight:700;">ğŸ¨ ê·¸ë¦¼íŒ</h3>
                <button onclick="closeModal('draw-modal')" style="background:none; border:none; font-size:20px; color:#999;">âœ•</button>
            </div>
            <canvas id="canvas" width="400" height="400"></canvas>
            <div style="display:flex; gap:10px;">
                <input type="color" id="draw-color" style="width:50px; height:45px; border-radius:8px; border:1px solid #eee;">
                <button onclick="clearCanvas()" class="modal-btn" style="flex:1; background:#f1f3f5; color:#555;">ì§€ìš°ê¸°</button>
                <button onclick="sendDraw()" class="modal-btn" style="flex:2; background:var(--main-blue); color:white;">ê·¸ë¦¼ ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3 style="font-weight:700;">ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</h3>
            <div id="emoji-picker" style="height:35vh; overflow-y:auto; border-radius:12px; border:1px solid #eee;"></div>
            <input type="text" id="set-name" class="auth-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
            <button onclick="saveProfile()" class="modal-btn" style="background:var(--main-blue); color:white; margin-bottom:10px;">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        /* ê¸°ì¡´ ê¸°ëŠ¥ ë° Firebase ë¡œì§ (v16ê³¼ ë™ì¼, ê±´ë“œë¦¬ì§€ ì•ŠìŒ) */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let userUID = null;
        let userData = { name: "", emoji: "ğŸ‘¤" };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUID = user.uid;
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('ui-input').style.display = 'block';
                onValue(ref(db, `users/${user.uid}`), (snap) => {
                    if(snap.exists()) {
                        userData = snap.val();
                        document.getElementById('h-name').innerText = userData.name;
                        document.getElementById('h-emoji').innerText = userData.emoji;
                    } else {
                        const init = { name: user.displayName || "ìµëª…", emoji: "ğŸ‘¤", uid: user.uid };
                        set(ref(db, `users/${user.uid}`), init);
                    }
                });
                const statusRef = ref(db, `status/${user.uid}`);
                set(statusRef, true);
                onDisconnect(statusRef).remove();
            } else {
                document.getElementById('auth-area').style.display = 'flex';
                document.getElementById('ui-input').style.display = 'none';
            }
        });

        window.emailAuth = async () => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            if(!email.includes('@')) return alert("ì´ë©”ì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
            try { await signInWithEmailAndPassword(auth, email, pw); } 
            catch (err) {
                if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    try { await createUserWithEmailAndPassword(auth, email, pw); } 
                    catch (e) { alert(e.message); }
                } else { alert(err.message); }
            }
        };

        window.googleLogin = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            push(ref(db, 'chat_v16'), {
                text: input.value, uid: userUID, name: userData.name, emoji: userData.emoji,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            input.value = "";
        };

        onChildAdded(ref(db, 'chat_v16'), (snap) => {
            const d = snap.val();
            const isMe = d.uid === userUID;
            const div = document.createElement('div');
            div.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;
            let content = d.type === 'draw' 
                ? `<img src="${d.image}" class="draw-msg" onclick="window.open('${d.image}')">`
                : `<div class="bubble">${d.text}</div>`;
            div.innerHTML = `<div class="user-info">${d.emoji} ${d.name}</div><div style="display:flex; align-items:flex-end; gap:6px; flex-direction:${isMe?'row-reverse':'row'}">${content} <span style="font-size:10px; color:#aaa;">${d.time}</span></div>`;
            const win = document.getElementById('chat-window');
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        });

        const cvs = document.getElementById('canvas');
        const ctx = cvs.getContext('2d');
        let drawing = false;
        const getXY = (e) => {
            const r = cvs.getBoundingClientRect();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (x - r.left) * (cvs.width / r.width), y: (y - r.top) * (cvs.height / r.height) };
        };
        cvs.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getXY(e); ctx.moveTo(p.x, p.y); });
        cvs.addEventListener('mousemove', (e) => { if(!drawing) return; const p = getXY(e); ctx.strokeStyle = document.getElementById('draw-color').value; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineTo(p.x, p.y); ctx.stroke(); });
        window.addEventListener('mouseup', () => drawing = false);
        cvs.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); const p = getXY(e); ctx.moveTo(p.x, p.y); });
        cvs.addEventListener('touchmove', (e) => { e.preventDefault(); if(!drawing) return; const p = getXY(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });

        window.openDraw = () => { document.getElementById('draw-modal').style.display = 'flex'; window.clearCanvas(); };
        window.clearCanvas = () => { ctx.fillStyle="white"; ctx.fillRect(0,0,400,400); };
        window.sendDraw = () => {
            const img = cvs.toDataURL('image/png', 0.5);
            push(ref(db, 'chat_v16'), { type: 'draw', image: img, uid: userUID, name: userData.name, emoji: userData.emoji, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            closeModal('draw-modal');
        };

        window.openProfile = () => { document.getElementById('set-name').value = userData.name; document.getElementById('profile-modal').style.display = 'flex'; };
        window.saveProfile = () => { update(ref(db, `users/${userUID}`), { name: document.getElementById('set-name').value, emoji: userData.emoji }); closeModal('profile-modal'); };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        onValue(ref(db, 'status'), s => document.getElementById('user-count').innerText = s.exists() ? Object.keys(s.val()).length : 0);
        const picker = new EmojiMart.Picker({ onEmojiSelect: (e) => { userData.emoji = e.native; document.getElementById('h-emoji').innerText = e.native; }, locale: 'ko' });
        document.getElementById('emoji-picker').appendChild(picker);
        document.getElementById('msg-input').onkeypress = (e) => e.key === 'Enter' && window.sendMsg();
    </script>
</body>
</html>
