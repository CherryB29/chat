<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Chat v19.0 - Final</title>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <style>
        :root { --main-blue: #0084ff; --bg-gray: #f0f2f5; --me-bubble: #0084ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #d1d8e0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 500px; background: var(--bg-gray); display: flex; flex-direction: column; height: 100%; position: relative; }
        header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; z-index: 10; }
        #notice-bar { background: #fff9db; padding: 8px 15px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffe066; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* ë©”ì‹œì§€ ë””ìì¸ */
        .msg-unit { display: flex; flex-direction: column; max-width: 85%; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.4; }
        .is-me .bubble { background: var(--me-bubble); color: white; border-bottom-right-radius: 2px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 2px; }
        
        /* íŠ¹ìˆ˜ ë©”ì‹œì§€ */
        .yt-thumb { width: 100%; max-width: 240px; border-radius: 10px; margin-top: 8px; cursor: pointer; border: 1px solid #eee; display: block; }
        .draw-img { max-width: 200px; border-radius: 10px; border: 1px solid #ddd; background: white; margin-top: 5px; cursor: pointer; }
        .poll-box { background: white; border-radius: 15px; padding: 15px; width: 220px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .poll-opt { background: #f0f2f5; padding: 10px; border-radius: 8px; margin-top: 5px; cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; }

        /* ì…ë ¥ì°½ */
        .input-container { background: white; padding: 10px; border-top: 1px solid #ddd; }
        #input-area { display: flex; gap: 8px; align-items: center; background: #f8f9fa; padding: 5px 12px; border-radius: 25px; }
        #msg-input { flex: 1; border: none; background: transparent; padding: 10px 0; outline: none; font-size: 16px; color: black; }
        
        /* ëª¨ë‹¬ ê³µí†µ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 12px; max-height: 85vh; overflow-y: auto; }
        #draw-canvas { background: white; border: 1px solid #ddd; border-radius: 10px; touch-action: none; width: 100%; }
        #emoji-picker-container { width: 100%; height: 300px; overflow: hidden; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div style="font-size:13px; font-weight:bold;">ğŸ’¬ Super Chat <span id="user-count">0</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div onclick="window.openProfileEdit()" style="cursor:pointer; background:#f0f2f5; padding:5px 12px; border-radius:15px; font-size:13px;">
                    <span id="header-emoji">ğŸ‘¤</span> <span id="header-name">ì„¤ì •</span>
                </div>
                <button onclick="window.handleLogout()" style="border:none; background:none; color:#ff4d4d; font-size:12px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div id="notice-bar">
            <div id="notice-text" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">ğŸ“¢ ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•´ ì£¼ì„¸ìš”.</div>
            <button onclick="window.openNoticeModal()" style="font-size:11px; padding:2px 5px; cursor:pointer;">ìˆ˜ì •</button>
        </div>

        <div id="chat-window"></div>

        <div class="input-container" id="chat-input-box" style="display:none;">
            <div id="input-area">
                <button onclick="window.openDrawModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸ¨</button>
                <button onclick="window.openPollModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸ“Š</button>
                <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." spellcheck="false" autocomplete="off">
                <button id="send-btn" style="background:var(--main-blue); border:none; width:36px; height:36px; border-radius:50%; color:white; font-weight:bold; cursor:pointer;">â†‘</button>
            </div>
        </div>
    </div>

    <div id="auth-area" style="position:fixed; inset:0; background:white; z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;">
        <div style="width:100%; max-width:320px; text-align:center;">
            <h2 style="margin-bottom:20px; color:var(--main-blue);">Super Chat</h2>
            <input type="email" id="email" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;" placeholder="ì´ë©”ì¼">
            <input type="password" id="password" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="window.handleEmailLogin()" style="width:100%; padding:12px; background:var(--main-blue); color:white; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px; cursor:pointer;">ë¡œê·¸ì¸</button>
            <button onclick="window.handleEmailSignUp()" style="width:100%; padding:12px; background:#34a853; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ì´ë©”ì¼ íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="draw-modal" class="modal"><div class="modal-content"><h4>ğŸ¨ ê·¸ë¦¼íŒ</h4><canvas id="draw-canvas" width="400" height="400"></canvas><div style="display:flex; justify-content:space-between;"><input type="color" id="draw-color" value="#000000"><button onclick="window.clearCanvas()">ì§€ìš°ê¸°</button></div><button onclick="window.sendDrawing()" style="padding:12px; background:var(--main-blue); color:white; border:none; border-radius:10px; cursor:pointer;">ê·¸ë¦¼ ì „ì†¡</button><button onclick="window.closeModal('draw-modal')" style="cursor:pointer;">ì·¨ì†Œ</button></div></div>
    <div id="profile-modal" class="modal"><div class="modal-content"><h4>ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</h4><div id="emoji-picker-container"></div><input type="text" id="setup-name" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px;" placeholder="ë‹‰ë„¤ì„"><button onclick="window.saveProfile()" style="padding:12px; background:var(--main-blue); color:white; border:none; border-radius:10px; cursor:pointer;">ì €ì¥</button><button onclick="window.closeModal('profile-modal')" style="cursor:pointer;">ë‹«ê¸°</button></div></div>
    <div id="poll-modal" class="modal"><div class="modal-content"><h4>ğŸ“Š íˆ¬í‘œ ë§Œë“¤ê¸°</h4><input type="text" id="poll-q" placeholder="ì§ˆë¬¸" style="padding:10px; border:1px solid #ddd; border-radius:10px;"><div id="poll-options-container" style="display:flex; flex-direction:column; gap:5px;"></div><button onclick="window.addPollOption()" style="cursor:pointer;">+ í•­ëª© ì¶”ê°€</button><button onclick="window.submitPoll()" style="background:var(--main-blue); color:white; padding:12px; border:none; border-radius:10px; cursor:pointer;">íˆ¬í‘œ ì˜¬ë¦¬ê¸°</button><button onclick="window.closeModal('poll-modal')" style="cursor:pointer;">ì·¨ì†Œ</button></div></div>
    <div id="notice-modal" class="modal"><div class="modal-content"><h4>ğŸ“¢ ê³µì§€ ìˆ˜ì •</h4><textarea id="notice-input" style="width:100%; height:80px; padding:10px; border:1px solid #ddd;"></textarea><button onclick="window.saveNotice()" style="padding:12px; background:var(--main-blue); color:white; border:none; border-radius:10px; cursor:pointer;">ë°˜ì˜</button><button onclick="window.closeModal('notice-modal')" style="cursor:pointer;">ë‹«ê¸°</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, update, remove, runTransaction, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const CHAT_PATH = 'chat_v18_final';
        
        let currentUID = null;
        let myInfo = { name: "Guest", emoji: "ğŸ‘¤" };

        // --- ìœ í‹¸ë¦¬í‹° (ë§í¬ ë° ìœ íŠœë¸Œ) ---
        const linkify = (t) => t.replace(/(https?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank" style="color:inherit; font-weight:bold; text-decoration:underline;">${url}</a>`);
        const getYTID = (url) => { const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/); return (m && m[2].length === 11) ? m[2] : null; };

        // --- ì „ì—­ í•¨ìˆ˜ ---
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.openDrawModal = () => { document.getElementById('draw-modal').style.display = 'flex'; window.clearCanvas(); };
        window.openPollModal = () => { document.getElementById('poll-options-container').innerHTML = ''; window.addPollOption(); window.addPollOption(); document.getElementById('poll-modal').style.display = 'flex'; };
        window.openNoticeModal = () => { onValue(ref(db, 'notice'), s => { document.getElementById('notice-input').value = s.val() || ""; }, {onlyOnce:true}); document.getElementById('notice-modal').style.display='flex'; };
        window.openProfileEdit = () => { document.getElementById('setup-name').value = myInfo.name; document.getElementById('profile-modal').style.display = 'flex'; };

        // --- ì¸ì¦ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUID = user.uid;
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('chat-input-box').style.display = 'block';
                onValue(ref(db, `users/${user.uid}`), (s) => {
                    if(s.exists()){
                        myInfo = s.val();
                        document.getElementById('header-name').innerText = myInfo.name;
                        document.getElementById('header-emoji').innerText = myInfo.emoji;
                    } else {
                        const init = { name: user.email.split('@')[0], emoji: "ğŸ‘¤", uid: user.uid };
                        set(ref(db, `users/${user.uid}`), init);
                    }
                });
                set(ref(db, `status/${user.uid}`), true);
                onDisconnect(ref(db, `status/${user.uid}`)).remove();
            } else {
                currentUID = null;
                document.getElementById('auth-area').style.display = 'flex';
                document.getElementById('chat-input-box').style.display = 'none';
            }
        });

        window.handleEmailLogin = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message));
        window.handleEmailSignUp = () => createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("ê°€ì… ì‹¤íŒ¨: " + e.message));
        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // --- ì „ì†¡ ë° ë Œë”ë§ ---
        const sendMsg = () => {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt || !currentUID) return;
            push(ref(db, CHAT_PATH), { text: txt, uid: currentUID, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            document.getElementById('msg-input').value = "";
        };
        document.getElementById('send-btn').onclick = sendMsg;
        document.getElementById('msg-input').onkeypress = (e) => e.key === 'Enter' && sendMsg();

        onChildAdded(ref(db, CHAT_PATH), (snap) => {
            const data = snap.val(); const key = snap.key; const isMe = data.uid === currentUID;
            const div = document.createElement('div');
            div.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;
            
            let contentHtml = "";
            if(data.type === 'draw') {
                contentHtml = `<img src="${data.image}" class="draw-img" onclick="window.open('${data.image}')">`;
            } else if(data.type === 'poll') {
                contentHtml = `<div class="poll-box"><strong>ğŸ“Š ${data.q}</strong>` + data.opts.map((o,i) => `<div class="poll-opt" onclick="window.vote('${key}',${i})">${o} <b id="v-${key}-${i}">${data.votes?data.votes[i]:0}</b></div>`).join('') + `</div>`;
            } else {
                const yid = getYTID(data.text || "");
                const yth = yid ? `<img src="https://img.youtube.com/vi/${yid}/mqdefault.jpg" class="yt-thumb" onclick="window.open('https://youtu.be/${yid}')">` : "";
                contentHtml = `<div class="bubble">${linkify(data.text)}</div>${yth}`;
            }

            div.innerHTML = `<div style="font-size:10px; color:#888; margin-bottom:2px;">${isMe ? 'ë‚˜' : (data.uid.slice(0,5))}</div><div style="display:flex; align-items:flex-end; gap:5px; flex-direction:${isMe?'row-reverse':'row'}">${contentHtml} <span style="font-size:10px; color:#999;">${data.time}</span></div>`;
            document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        });

        // --- ê¸°íƒ€ ê¸°ëŠ¥ êµ¬í˜„ ---
        window.sendDrawing = () => { push(ref(db, CHAT_PATH), { type:'draw', image: canvas.toDataURL('image/png', 0.5), uid: currentUID, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }); window.closeModal('draw-modal'); };
        window.addPollOption = () => { const i = document.createElement('input'); i.className="p-opt-in"; i.placeholder="í•­ëª©"; i.style.padding="8px"; document.getElementById('poll-options-container').appendChild(i); };
        window.submitPoll = () => { const q=document.getElementById('poll-q').value; const opts=Array.from(document.querySelectorAll('.p-opt-in')).map(e=>e.value).filter(v=>v.trim()); if(q && opts.length>1) { push(ref(db, CHAT_PATH), { type:'poll', q, opts, votes:opts.map(()=>0), uid:currentUID, time:new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }); window.closeModal('poll-modal'); }};
        window.vote = (key, i) => runTransaction(ref(db, `${CHAT_PATH}/${key}/votes/${i}`), v => (v||0)+1);
        window.saveNotice = () => { set(ref(db, 'notice'), document.getElementById('notice-input').value); window.closeModal('notice-modal'); };
        onValue(ref(db, 'notice'), s => document.getElementById('notice-text').innerText = "ğŸ“¢ " + (s.val() || "ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."));
        window.saveProfile = () => { update(ref(db, `users/${currentUID}`), {name: document.getElementById('setup-name').value, emoji: myInfo.emoji}); window.closeModal('profile-modal'); };
        onValue(ref(db, 'status'), s => document.getElementById('user-count').innerText = s.val() ? Object.keys(s.val()).length : 0);
        
        const picker = new EmojiMart.Picker({ onEmojiSelect: (e) => { myInfo.emoji = e.native; document.getElementById('header-emoji').innerText = e.native; }, locale: 'ko' });
        document.getElementById('emoji-picker-container').appendChild(picker);

        const canvas = document.getElementById('draw-canvas'); const ctx = canvas.getContext('2d'); let drawing = false;
        window.clearCanvas = () => { ctx.fillStyle="white"; ctx.fillRect(0,0,400,400); };
        const getP = (e) => { const r = canvas.getBoundingClientRect(); const x = e.touches ? e.touches[0].clientX : e.clientX; const y = e.touches ? e.touches[0].clientY : e.clientY; return { x: (x-r.left)*(400/r.width), y: (y-r.top)*(400/r.height) }; };
        canvas.addEventListener('mousedown', (e) => { drawing=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(p.x,p.y); });
        canvas.addEventListener('mousemove', (e) => { if(!drawing) return; const p=getP(e); ctx.strokeStyle = document.getElementById('draw-color').value; ctx.lineWidth = 3; ctx.lineTo(p.x, p.y); ctx.stroke(); });
        canvas.addEventListener('mouseup', () => drawing=false);
        canvas.addEventListener('touchstart', (e) => { drawing=true; ctx.beginPath(); const p=getP(e); ctx.moveTo(getP(e).x,getP(e).y); e.preventDefault(); });
        canvas.addEventListener('touchmove', (e) => { if(!drawing) return; const p=getP(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); });
        canvas.addEventListener('touchend', () => drawing=false);

        onValue(ref(db, CHAT_PATH), s => s.forEach(c => { const d = c.val(); if(d.type === 'poll' && d.votes) d.votes.forEach((v, i) => { const el = document.getElementById(`v-${c.key}-${i}`); if(el) el.innerText = v; }); }));
    </script>
</body>
</html>
