<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Super Chat v16 - Drawing & Auth</title>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <style>
        :root { --main-blue: #0084ff; --bg-gray: #f0f2f5; --me-bubble: #0084ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        /* í•œê¸€ ê¹¨ì§ ë°©ì§€ í°íŠ¸ ì„¤ì • */
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background: #d1d8e0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }

        .app-container { width: 100%; max-width: 500px; background: var(--bg-gray); display: flex; flex-direction: column; height: 100%; position: relative; }
        
        /* í—¤ë” */
        header { background: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; z-index: 100; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg-unit { display: flex; flex-direction: column; max-width: 85%; margin-bottom: 4px; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }
        .user-info { font-size: 11px; color: #666; margin-bottom: 2px; }
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; word-break: break-all; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .is-me .bubble { background: var(--me-bubble); color: white; border-bottom-right-radius: 2px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 2px; }
        
        .draw-msg { max-width: 200px; border-radius: 12px; border: 1px solid #ddd; background: white; margin-top: 5px; }

        /* í•˜ë‹¨ ì…ë ¥ì°½ (ëª¨ë°”ì¼ ìµœì í™”) */
        .input-bar { background: white; padding: 10px; border-top: 1px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .input-inner { display: flex; gap: 8px; align-items: center; background: #f1f3f5; padding: 5px 12px; border-radius: 25px; }
        #msg-input { flex: 1; border: none; background: transparent; padding: 10px 0; outline: none; font-size: 16px; }
        .send-btn { background: var(--main-blue); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; }

        /* ì¸ì¦ ë ˆì´ì–´ */
        .auth-screen { position: fixed; inset: 0; background: #f0f2f5; z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 340px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        
        /* ëª¨ë‹¬ ê³µí†µ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        canvas { background: white; border: 1px solid #ccc; width: 100%; aspect-ratio: 1/1; touch-action: none; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div style="font-weight:bold;">ğŸ’¬ Super Chat <span id="user-count" style="color:var(--main-blue)">0</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div onclick="openProfile()" style="cursor:pointer; background:#f1f3f5; padding:5px 12px; border-radius:15px; font-size:13px;">
                    <span id="h-emoji">ğŸ‘¤</span> <span id="h-name">ì„¤ì •</span>
                </div>
                <button onclick="logout()" style="border:none; background:none; color:#ff4d4d; font-size:12px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div id="chat-window"></div>

        <div class="input-bar" id="ui-input" style="display:none;">
            <div class="input-inner">
                <button onclick="openDraw()" style="background:none; border:none; font-size:22px;">ğŸ¨</button>
                <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
                <button onclick="sendMsg()" class="send-btn">â†‘</button>
            </div>
        </div>
    </div>

    <div id="auth-area" class="auth-screen">
        <div class="auth-card">
            <h2 style="margin-bottom:20px; color:var(--main-blue);">ìŠˆí¼ ì±„íŒ… v16</h2>
            <input type="email" id="email" class="auth-input" placeholder="ì´ë©”ì¼ (abc@test.com)">
            <input type="password" id="password" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="emailAuth()" style="width:100%; padding:14px; background:var(--main-blue); color:white; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px;">ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…</button>
            <div style="margin-bottom:15px; font-size:12px; color:#999;">ë˜ëŠ”</div>
            <button onclick="googleLogin()" style="width:100%; padding:12px; background:white; border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18"> Google ë¡œê·¸ì¸
            </button>
        </div>
    </div>

    <div id="draw-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ¨ ê·¸ë¦¼ ê·¸ë¦¬ê¸°</h3>
            <canvas id="canvas" width="400" height="400"></canvas>
            <div style="display:flex; gap:10px;">
                <input type="color" id="draw-color" style="width:50px;">
                <button onclick="clearCanvas()" style="flex:1; padding:10px;">ì§€ìš°ê¸°</button>
                <button onclick="sendDraw()" style="flex:2; background:var(--main-blue); color:white; border:none; border-radius:8px; font-weight:bold;">ì „ì†¡</button>
            </div>
            <button onclick="closeModal('draw-modal')" style="background:none; border:none; color:#888;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</h3>
            <div id="emoji-picker" style="height:300px; overflow:hidden;"></div>
            <input type="text" id="set-name" class="auth-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
            <button onclick="saveProfile()" style="width:100%; padding:14px; background:var(--main-blue); color:white; border:none; border-radius:8px; font-weight:bold;">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, update, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Firebase ì„¤ì • (ì •ë³´ê°€ ì •í™•í•œì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        let userUID = null;
        let userData = { name: "", emoji: "ğŸ‘¤" };

        // --- ğŸ” ì¸ì¦ ë¡œì§ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUID = user.uid;
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('ui-input').style.display = 'block';
                
                onValue(ref(db, `users/${user.uid}`), (snap) => {
                    if(snap.exists()) {
                        userData = snap.val();
                        document.getElementById('h-name').innerText = userData.name;
                        document.getElementById('h-emoji').innerText = userData.emoji;
                    } else {
                        const init = { name: user.displayName || "ìµëª…", emoji: "ğŸ‘¤", uid: user.uid };
                        set(ref(db, `users/${user.uid}`), init);
                    }
                });

                // ì ‘ì† ìƒíƒœ ì²´í¬
                const statusRef = ref(db, `status/${user.uid}`);
                set(statusRef, true);
                onDisconnect(statusRef).remove();
            } else {
                document.getElementById('auth-area').style.display = 'flex';
                document.getElementById('ui-input').style.display = 'none';
            }
        });

        // ì´ë©”ì¼ ë¡œê·¸ì¸/ê°€ì… í†µí•©
        window.emailAuth = async () => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            if(!email.includes('@')) return alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                await signInWithEmailAndPassword(auth, email, pw);
            } catch (err) {
                if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pw);
                        alert("ê°€ì… ë° ë¡œê·¸ì¸ ì„±ê³µ!");
                    } catch (e) { alert("ê°€ì… ì‹¤íŒ¨: " + e.message); }
                } else { alert("ì˜¤ë¥˜: " + err.message); }
            }
        };

        // êµ¬ê¸€ ë¡œê·¸ì¸
        window.googleLogin = () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => {
                if(location.protocol === 'file:') alert("ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì¤‘ì—ëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. ì´ë©”ì¼ ë¡œê·¸ì¸ì„ ì‚¬ìš©í•˜ì„¸ìš”.");
                else alert(e.message);
            });
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        // --- ğŸ’¬ ì±„íŒ… ë¡œì§ ---
        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            push(ref(db, 'chat_v16'), {
                text: input.value,
                uid: userUID,
                name: userData.name,
                emoji: userData.emoji,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            input.value = "";
        };

        onChildAdded(ref(db, 'chat_v16'), (snap) => {
            const d = snap.val();
            const isMe = d.uid === userUID;
            const div = document.createElement('div');
            div.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;
            
            let content = d.type === 'draw' 
                ? `<img src="${d.image}" class="draw-msg" onclick="window.open('${d.image}')">`
                : `<div class="bubble">${d.text}</div>`;

            div.innerHTML = `
                <div class="user-info">${d.emoji} ${d.name}</div>
                <div style="display:flex; align-items:flex-end; gap:5px; flex-direction:${isMe?'row-reverse':'row'}">
                    ${content} <span style="font-size:10px; color:#999;">${d.time}</span>
                </div>`;
            
            const win = document.getElementById('chat-window');
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        });

        // --- ğŸ¨ ê·¸ë¦¼íŒ ---
        const cvs = document.getElementById('canvas');
        const ctx = cvs.getContext('2d');
        let drawing = false;

        const getXY = (e) => {
            const r = cvs.getBoundingClientRect();
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (x - r.left) * (cvs.width / r.width), y: (y - r.top) * (cvs.height / r.height) };
        };

        const start = (e) => { drawing = true; ctx.beginPath(); const p = getXY(e); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!drawing) return; const p = getXY(e); ctx.strokeStyle = document.getElementById('draw-color').value; ctx.lineWidth = 3; ctx.lineTo(p.x, p.y); ctx.stroke(); };
        const end = () => drawing = false;

        cvs.addEventListener('mousedown', start); cvs.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        cvs.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
        cvs.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); });

        window.openDraw = () => { document.getElementById('draw-modal').style.display = 'flex'; window.clearCanvas(); };
        window.clearCanvas = () => { ctx.fillStyle="white"; ctx.fillRect(0,0,400,400); };
        window.sendDraw = () => {
            const img = cvs.toDataURL('image/png', 0.5);
            push(ref(db, 'chat_v16'), { type: 'draw', image: img, uid: userUID, name: userData.name, emoji: userData.emoji, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            closeModal('draw-modal');
        };

        // --- ğŸ‘¤ í”„ë¡œí•„/ê¸°íƒ€ ---
        window.openProfile = () => { document.getElementById('set-name').value = userData.name; document.getElementById('profile-modal').style.display = 'flex'; };
        window.saveProfile = () => { update(ref(db, `users/${userUID}`), { name: document.getElementById('set-name').value, emoji: userData.emoji }); closeModal('profile-modal'); };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        onValue(ref(db, 'status'), s => document.getElementById('user-count').innerText = s.exists() ? Object.keys(s.val()).length : 0);
        
        const picker = new EmojiMart.Picker({ onEmojiSelect: (e) => { userData.emoji = e.native; document.getElementById('h-emoji').innerText = e.native; }, locale: 'ko' });
        document.getElementById('emoji-picker').appendChild(picker);
        
        // ì—”í„°í‚¤ ì „ì†¡ ì§€ì›
        document.getElementById('msg-input').onkeypress = (e) => e.key === 'Enter' && window.sendMsg();
    </script>
</body>
</html>
