<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠˆí¼ ì±„íŒ…ë°© v5</title>
    <style>
        :root { --main-blue: #0084ff; --msg-gray: #f1f0f0; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ìƒë‹¨ ìƒíƒœë°” */
        header { background: white; padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 14px; position: sticky; top: 0; z-index: 10; }
        #user-count { color: var(--main-blue); }

        /* ì¸ì¦ ë ˆì´ì–´ */
        #auth-area { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .auth-box { display: flex; flex-direction: column; gap: 10px; width: 300px; padding: 20px; border: 1px solid #ddd; border-radius: 15px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }

        /* ì±„íŒ… ì˜ì—­ */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-unit { display: flex; flex-direction: column; max-width: 80%; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }

        .user-info { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 12px; color: #555; }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: #eee; border: 1px solid #ddd; }
        
        .bubble { padding: 10px 15px; border-radius: 18px; font-size: 15px; position: relative; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .is-me .bubble { background: var(--main-blue); color: white; border-bottom-right-radius: 2px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 2px; }

        .meta-info { display: flex; gap: 10px; align-items: center; margin-top: 5px; font-size: 11px; color: #888; }
        .like-btn { cursor: pointer; color: #ff4757; border: 1px solid #ffdada; padding: 2px 8px; border-radius: 10px; background: white; display: flex; align-items: center; gap: 4px; }
        .like-btn:hover { background: #fff5f5; }

        /* ì…ë ¥ë°” */
        #input-area { background: white; padding: 15px; display: none; gap: 10px; border-top: 1px solid #ddd; }
    </style>
</head>
<body>

    <header>ğŸ“¡ <span id="user-count">0</span>ëª…ì´ í•¨ê»˜ ëŒ€í™” ì¤‘ì…ë‹ˆë‹¤</header>

    <div id="auth-area">
        <h2 style="margin-bottom: 5px;">ë°˜ê°‘ìŠµë‹ˆë‹¤! ğŸ‘‹</h2>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">ë‹‰ë„¤ì„ì„ ì •í•˜ê³  ë¡œê·¸ì¸ì„ ì§„í–‰í•˜ì„¸ìš”.</p>
        <div class="auth-box">
            <input type="text" id="nickname" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„">
            <input type="email" id="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
            <button style="background: #34a853; color: white;" onclick="emailLogin()">ì´ë©”ì¼ë¡œ ì‹œì‘í•˜ê¸°</button>
        </div>
        <button style="background: #4285F4; color: white; width: 300px;" id="google-login">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="chat-window"></div>
    
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex:1; border-radius: 25px; padding-left: 20px;">
        <button id="send-btn" style="background: var(--main-blue); color: white; border-radius: 50%; width: 45px; height: 45px; padding: 0;">âœˆ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
            measurementId: "G-QS22EDDL9V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let myProfile = { name: "", photo: "" };

        // --- 1. ì¸ì¦ ë¡œì§ ---
        document.getElementById('google-login').onclick = () => signInWithPopup(auth, provider);
        
        window.emailLogin = async () => {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            if(pw.length < 6) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            
            try {
                await signInWithEmailAndPassword(auth, email, pw);
            } catch (err) {
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') {
                    await createUserWithEmailAndPassword(auth, email, pw);
                } else { alert("ì˜¤ë¥˜: " + err.message); }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const nickInput = document.getElementById('nickname').value;
                myProfile.name = nickInput || user.displayName || user.email.split('@')[0];
                myProfile.photo = user.photoURL || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
                
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('input-area').style.display = 'flex';

                // ì ‘ì† ì¤‘ í‘œì‹œ
                const statusRef = ref(db, `status/${user.uid}`);
                set(statusRef, { name: myProfile.name });
                onDisconnect(statusRef).remove();
            }
        });

        // ì ‘ì†ì ìˆ˜ ì²´í¬
        onValue(ref(db, 'status'), (snap) => {
            document.getElementById('user-count').innerText = snap.size || 0;
        });

        // --- 2. ì±„íŒ… ë¡œì§ ---
        const sendMsg = () => {
            const text = document.getElementById('msg-input').value.trim();
            if (!text) return;
            
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            push(ref(db, 'chat_final'), {
                text, time,
                sender: myProfile.name,
                photo: myProfile.photo,
                uid: auth.currentUser.uid,
                likes: 0
            });
            document.getElementById('msg-input').value = "";
        };

        document.getElementById('send-btn').onclick = sendMsg;
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };

        // ë©”ì‹œì§€ í‘œì‹œ ë° ì¢‹ì•„ìš” ì‹¤ì‹œê°„ ê°ì‹œ
        onChildAdded(ref(db, 'chat_final'), (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;
            const isMe = data.uid === auth.currentUser?.uid;

            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;
            msgDiv.id = `unit-${key}`;
            
            msgDiv.innerHTML = `
                <div class="user-info">
                    ${!isMe ? `<img src="${data.photo}" class="avatar">` : ''}
                    <span>${data.sender}</span>
                </div>
                <div class="bubble">${data.text}</div>
                <div class="meta-info">
                    <span>${data.time}</span>
                    <button class="like-btn" onclick="addLike('${key}')">â¤ï¸ <span id="likes-${key}">${data.likes || 0}</span></button>
                </div>
            `;
            document.getElementById('chat-window').appendChild(msgDiv);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;

            // ì¢‹ì•„ìš” ì‹¤ì‹œê°„ ì—°ë™
            onValue(ref(db, `chat_final/${key}/likes`), (s) => {
                const countEl = document.getElementById(`likes-${key}`);
                if(countEl) countEl.innerText = s.val() || 0;
            });
        });

        // ì¢‹ì•„ìš” ì¦ê°€ í•¨ìˆ˜ (íŠ¸ëœì­ì…˜ ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ)
        window.addLike = (key) => {
            const likeRef = ref(db, `chat_final/${key}/likes`);
            runTransaction(likeRef, (current) => {
                return (current || 0) + 1;
            });
        };
    </script>
</body>
</html>
