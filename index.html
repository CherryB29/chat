<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠˆí¼ ì±„íŒ… v7 - ê³µì§€ & íˆ¬í‘œ</title>
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
    <style>
        :root { --main-blue: #0084ff; --bg-gray: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* í—¤ë” & ê³µì§€ */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; z-index: 10; }
        #notice-bar { background: #fff9db; padding: 10px 20px; font-size: 14px; border-bottom: 1px solid #ffe066; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .notice-admin { cursor: pointer; color: #f08c00; font-size: 12px; border: 1px solid; padding: 2px 6px; border-radius: 4px; }

        /* ì±„íŒ… ë° ë§í’ì„  */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg-unit { display: flex; flex-direction: column; max-width: 85%; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-break: break-all; }
        .is-me .bubble { background: var(--main-blue); color: white; border-bottom-right-radius: 2px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 2px; }

        /* íˆ¬í‘œ ìŠ¤íƒ€ì¼ */
        .poll-card { background: white; border: 1px solid #ddd; border-radius: 12px; padding: 15px; width: 250px; margin-top: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); color: #333; }
        .poll-option { background: #f1f3f5; margin-top: 8px; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; }
        .poll-option:hover { background: #e9ecef; }
        .poll-bar { height: 4px; background: var(--main-blue); border-radius: 2px; margin-top: 4px; transition: width 0.5s; }

        /* ì…ë ¥ì°½ & ë²„íŠ¼ */
        #input-area { background: white; padding: 15px; display: none; gap: 10px; border-top: 1px solid #ddd; align-items: center; }
        #msg-input { flex: 1; padding: 12px 20px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .tool-btn { font-size: 20px; cursor: pointer; background: none; border: none; padding: 5px; }

        /* ê³µí†µ ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 320px; display: flex; flex-direction: column; gap: 12px; }
        
        #auth-area { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
    </style>
</head>
<body>

    <header>
        <div style="font-size:13px;">ğŸ‘¥ <span id="user-count">0</span>ëª…</div>
        <div onclick="openProfileEdit()" style="cursor:pointer; font-weight:bold;">
            <span id="header-emoji">ğŸ‘¤</span> <span id="header-name">ë‹‰ë„¤ì„</span>
        </div>
    </header>

    <div id="notice-bar">
        <span>ğŸ“¢ <span id="notice-text">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</span></span>
        <span class="notice-admin" onclick="openNoticeModal()">ê´€ë¦¬</span>
    </div>

    <div id="auth-area">
        <h2>ìŠˆí¼ ì±„íŒ… ì…ì¥</h2>
        <button style="background: #4285F4; color: white; width: 260px; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;" id="google-login">Googleë¡œ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="poll-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“Š íˆ¬í‘œ ë§Œë“¤ê¸°</h3>
            <input type="text" id="poll-q" placeholder="ì§ˆë¬¸ (ì˜ˆ: ì ì‹¬ ë©”ë‰´?)" style="padding:10px;">
            <input type="text" id="poll-o1" placeholder="ì„ íƒì§€ 1" style="padding:10px;">
            <input type="text" id="poll-o2" placeholder="ì„ íƒì§€ 2" style="padding:10px;">
            <button onclick="createPoll()" style="background:var(--main-blue); color:white; padding:12px; border:none; border-radius:10px; font-weight:bold;">íˆ¬í‘œ ì˜¬ë¦¬ê¸°</button>
            <button onclick="closeModal('poll-modal')" style="background:#eee; padding:10px; border:none; border-radius:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="notice-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¢ ê³µì§€ ìˆ˜ì •</h3>
            <input type="text" id="new-notice" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="padding:10px;">
            <button onclick="saveNotice()" style="background:#f08c00; color:white; padding:12px; border:none; border-radius:10px; font-weight:bold;">ê³µì§€ ì ìš©</button>
            <button onclick="closeModal('notice-modal')" style="background:#eee; padding:10px; border:none; border-radius:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="chat-window"></div>

    <div id="input-area">
        <button class="tool-btn" onclick="document.getElementById('poll-modal').style.display='flex'">ğŸ“Š</button>
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="send-btn" style="background:var(--main-blue); color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">ì „ì†¡</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
            measurementId: "G-QS22EDDL9V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let myInfo = { name: "", emoji: "ğŸ‘¤", uid: "" };

        // 1. ê³µì§€ì‚¬í•­ ë¡œì§
        window.openNoticeModal = () => document.getElementById('notice-modal').style.display = 'flex';
        window.saveNotice = () => {
            const text = document.getElementById('new-notice').value;
            set(ref(db, 'notice'), text);
            closeModal('notice-modal');
        };
        onValue(ref(db, 'notice'), (snap) => {
            document.getElementById('notice-text').innerText = snap.val() || "ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
        });

        // 2. íˆ¬í‘œ ë§Œë“¤ê¸° ë¡œì§
        window.createPoll = () => {
            const q = document.getElementById('poll-q').value;
            const o1 = document.getElementById('poll-o1').value;
            const o2 = document.getElementById('poll-o2').value;
            if(!q || !o1 || !o2) return alert("ë‚´ìš©ì„ ë‹¤ ì±„ì›Œì£¼ì„¸ìš”!");
            
            push(ref(db, 'chat_v7'), {
                type: 'poll',
                question: q,
                opt1: o1, opt2: o2,
                v1: 0, v2: 0,
                sender: myInfo.name,
                uid: myInfo.uid
            });
            closeModal('poll-modal');
        };

        // 3. íˆ¬í‘œ ì°¸ì—¬ ë¡œì§ (íŠ¸ëœì­ì…˜ ì‚¬ìš©)
        window.vote = (key, optNum) => {
            const voteRef = ref(db, `chat_v7/${key}/v${optNum}`);
            runTransaction(voteRef, (curr) => (curr || 0) + 1);
        };

        // 4. ê¸°ë³¸ ì±„íŒ… & ì¸ì¦ ë¡œì§
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        document.getElementById('google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myInfo.uid = user.uid;
                myInfo.name = user.displayName;
                document.getElementById('auth-area').style.display = 'none';
                document.getElementById('input-area').style.display = 'flex';
                document.getElementById('header-name').innerText = myInfo.name;
                
                const statusRef = ref(db, `status/${user.uid}`);
                set(statusRef, { name: myInfo.name });
                onDisconnect(statusRef).remove();
            }
        });

        onValue(ref(db, 'status'), (snap) => document.getElementById('user-count').innerText = snap.size || 0);

        const sendMsg = () => {
            const text = document.getElementById('msg-input').value.trim();
            if (!text) return;
            push(ref(db, 'chat_v7'), {
                text, sender: myInfo.name, emoji: myInfo.emoji, uid: myInfo.uid,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            document.getElementById('msg-input').value = "";
        };
        document.getElementById('send-btn').onclick = sendMsg;

        // ë©”ì‹œì§€/íˆ¬í‘œ ë Œë”ë§
        onChildAdded(ref(db, 'chat_v7'), (snapshot) => {
            const data = snapshot.val();
            const key = snapshot.key;
            const isMe = data.uid === myInfo.uid;
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;

            if (data.type === 'poll') {
                msgDiv.innerHTML = `
                    <div class="user-tag"><b>ğŸ“Š ${data.sender}ì˜ íˆ¬í‘œ</b></div>
                    <div class="poll-card">
                        <strong>${data.question}</strong>
                        <div class="poll-option" onclick="vote('${key}', 1)">
                            <span>${data.opt1}</span> <b id="v1-${key}">${data.v1}</b>
                        </div>
                        <div class="poll-option" onclick="vote('${key}', 2)">
                            <span>${data.opt2}</span> <b id="v2-${key}">${data.v2}</b>
                        </div>
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="user-tag"><b>${data.sender}</b></div>
                    <div class="bubble">${data.text}</div>
                    <div style="font-size:10px; color:#999; margin-top:4px;">${data.time}</div>
                `;
            }
            document.getElementById('chat-window').appendChild(msgDiv);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;

            // íˆ¬í‘œìˆ˜ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì‹œ
            if(data.type === 'poll') {
                onValue(ref(db, `chat_v7/${key}/v1`), s => document.getElementById(`v1-${key}`).innerText = s.val() || 0);
                onValue(ref(db, `chat_v7/${key}/v2`), s => document.getElementById(`v2-${key}`).innerText = s.val() || 0);
            }
        });
    </script>
</body>
</html>
