<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë°”íƒ€ ì±„íŒ…ë°©</title>
    <style>
        :root { --main-blue: #0084ff; --bg-gray: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* í—¤ë” */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .user-status { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: bold; }
        .my-profile-preview { display: flex; align-items: center; gap: 8px; cursor: pointer; background: #eee; padding: 4px 12px; border-radius: 20px; font-size: 13px; }

        /* ì±„íŒ… ì˜ì—­ */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg-unit { display: flex; flex-direction: column; max-width: 80%; }
        .is-me { align-self: flex-end; align-items: flex-end; }
        .is-other { align-self: flex-start; align-items: flex-start; }
        
        .user-tag { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; font-size: 12px; color: #555; }
        .avatar-img { width: 30px; height: 30px; border-radius: 50%; background: white; border: 1px solid #ddd; }
        
        .bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.4; }
        .is-me .bubble { background: var(--main-blue); color: white; border-bottom-right-radius: 2px; }
        .is-other .bubble { background: white; color: black; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 10px; color: #999; margin-top: 4px; }

        /* ì…ë ¥ì°½ */
        #input-area { background: white; padding: 15px; display: none; gap: 10px; border-top: 1px solid #ddd; }
        #msg-input { flex: 1; padding: 12px 20px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        #send-btn { background: var(--main-blue); color: white; border: none; padding: 0 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }

        /* í”„ë¡œí•„ ì„¤ì • ëª¨ë‹¬ (ì´ˆê¸° ì§„ì… ë° ìˆ˜ì •ìš©) */
        #profile-setup { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .avatar-choice { width: 70px; height: 70px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .avatar-choice.selected { border-color: var(--main-blue); transform: scale(1.1); }
        .setup-input { padding: 12px; width: 240px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 16px; }
    </style>
</head>
<body>

    <header>
        <div class="user-status">ğŸŸ¢ ì ‘ì† <span id="user-count">0</span>ëª…</div>
        <div class="my-profile-preview" onclick="location.reload()">
            <img id="header-avatar" src="" style="width:24px; height:24px; border-radius:50%; display:none;">
            <span id="header-name">ë¡œê·¸ì¸ í•„ìš”</span>
        </div>
    </header>

    <div id="profile-setup">
        <h2 style="margin:0;">ìºë¦­í„° ë§Œë“¤ê¸°</h2>
        <p style="color:#666; font-size:14px; margin:0;">ì±„íŒ…ë°©ì—ì„œ ì‚¬ìš©í•  ëª¨ìŠµê³¼ ì´ë¦„ì„ ê³¨ë¼ì£¼ì„¸ìš”.</p>
        <div class="avatar-grid" id="avatar-grid"></div>
        <input type="text" id="setup-name" class="setup-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 8ì)" maxlength="8">
        <button id="start-btn" style="background: var(--main-blue); color:white; padding:15px 60px; border:none; border-radius:30px; font-size:16px; font-weight:bold; cursor:pointer;">ì±„íŒ… ì‹œì‘í•˜ê¸°</button>
        <button id="google-login-btn" style="background:#4285F4; color:white; padding:10px 20px; border:none; border-radius:5px; margin-top:10px; cursor:pointer;">ë˜ëŠ” êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</button>
    </div>

    <div id="chat-window"></div>

    <div id="input-area">
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="send-btn">ì „ì†¡</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVZVHumJQptb3P_sQT1yMAuVRhANI6Dj4",
            authDomain: "whiteboard-5e13d.firebaseapp.com",
            databaseURL: "https://whiteboard-5e13d-default-rtdb.firebaseio.com",
            projectId: "whiteboard-5e13d",
            storageBucket: "whiteboard-5e13d.firebasestorage.app",
            messagingSenderId: "665556862019",
            appId: "1:665556862019:web:c682afdb1cd13f3150c0f6",
            measurementId: "G-QS22EDDL9V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let myInfo = { name: "", avatar: "" };
        const seeds = ["Buddy", "Daisy", "Bubba", "Cookie", "Bear", "Lucky"];
        const grid = document.getElementById('avatar-grid');

        // ì•„ë°”íƒ€ ì„ íƒì§€ ìƒì„±
        seeds.forEach(seed => {
            const url = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}`;
            const img = document.createElement('img');
            img.src = url;
            img.className = 'avatar-choice';
            img.onclick = () => {
                document.querySelectorAll('.avatar-choice').forEach(el => el.classList.remove('selected'));
                img.classList.add('selected');
                myInfo.avatar = url;
            };
            grid.appendChild(img);
        });

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­
        document.getElementById('start-btn').onclick = () => {
            const name = document.getElementById('setup-name').value.trim();
            if(!name || !myInfo.avatar) return alert("ë‹‰ë„¤ì„ê³¼ ìºë¦­í„°ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”!");
            myInfo.name = name;
            enterChat();
        };

        // êµ¬ê¸€ ë¡œê·¸ì¸
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myInfo.name = user.displayName;
                myInfo.avatar = user.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${user.uid}`;
                enterChat();
            }
        });

        function enterChat() {
            document.getElementById('profile-setup').style.display = 'none';
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('header-avatar').src = myInfo.avatar;
            document.getElementById('header-avatar').style.display = 'block';
            document.getElementById('header-name').innerText = myInfo.name;

            // ì ‘ì† ìƒíƒœ ê¸°ë¡
            const myStatusRef = ref(db, `status/${Date.now()}`);
            set(myStatusRef, { name: myInfo.name });
            onDisconnect(myStatusRef).remove();
        }

        // ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
        onValue(ref(db, 'status'), (snap) => document.getElementById('user-count').innerText = snap.size || 0);

        // ë©”ì‹œì§€ ì „ì†¡
        const sendMsg = () => {
            const text = document.getElementById('msg-input').value.trim();
            if (!text) return;
            push(ref(db, 'chat_v_avatar'), {
                text, sender: myInfo.name, avatar: myInfo.avatar,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            });
            document.getElementById('msg-input').value = "";
        };

        document.getElementById('send-btn').onclick = sendMsg;
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };

        // ë©”ì‹œì§€ ìˆ˜ì‹ 
        onChildAdded(ref(db, 'chat_v_avatar'), (snapshot) => {
            const data = snapshot.val();
            const isMe = data.sender === myInfo.name;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-unit ${isMe ? 'is-me' : 'is-other'}`;
            msgDiv.innerHTML = `
                <div class="user-tag">
                    ${!isMe ? `<img src="${data.avatar}" class="avatar-img">` : ''}
                    <b>${data.sender}</b>
                </div>
                <div class="bubble">${data.text}</div>
                <div class="msg-time">${data.time}</div>
            `;
            document.getElementById('chat-window').appendChild(msgDiv);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        });
    </script>
</body>
</html>
